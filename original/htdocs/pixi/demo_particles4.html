<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>IPPEX</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000000;
        }

        .rendererView {
            position: absolute;
            display: block;
            height: 100%;
        }
        .console {
          display: block;
          margin: 0;
          width: 100%;
          /*font-family: sans-serif;*/
          font-size: 28px;
          font-weight: lighter;
          appearance: none;
          box-shadow: none;
          border-radius: none;
          background: transparent;
          border: none;
          color: #f8ffd4;
        }
        .console:focus {
          outline: none;
        }
        .title{
            color: white;
        }
        #console {
          font-size: 16px;
          height: 350px;
          width: 300px;
          color: #d4ffe2;
        }
    </style>
    <link rel="stylesheet" href="../bower_components/katex/dist/katex.min.css">
    <script src="../bower_components/katex/dist/katex.min.js"></script>
</head>

<body>
<div id="title" class="title" style="position: absolute; top: 10px; left: 100px;'">
    <!-- <i class="fa fa-globe fa-inverse fa-3x"></i> -->
    <input type="text" id="status" class="console"></input>
    <textarea type="text" id="console" class="console"></textarea>
</div>
<div id="container"></div>
<script src="../js/stats.min.js"></script>
<script src="../js/dat.gui.min.js"></script>
<!-- // <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> -->
<!-- // <script src="//cdnjs.cloudflare.com/ajax/libs/pixi.js/1.5.3/pixi.js"></script> -->
<script src="../js/TweenMax.min.js"></script>
<script src="../js/jquery-2.1.3.min.js"></script>
<script src="../bower_components/pixi/bin/pixi.min.js"></script>
<!-- // <script src="js/jquery.mobile-1.4.5.min.js"></script> -->
<!-- // <script src="../js/konva.min.js"></script> -->
<script src="../js/ui.js"></script>
<!-- // <script src="../js/math.js"></script> -->
<!-- // <script src="js/ui.js"></script> -->
<!-- // <script src="js/slider.js"></script> -->
<!-- // <script src="js/button.js"></script> -->
<script src="toka.js"></script>
<script defer="defer">

//*****Physics constants and variables*************

var K_BOLT = 1.6021e-16; // Boltzmann's constant
var MU_0 = 4.0e-7 * Math.PI;  // Permittivity
var E_ALPHA_0 = 3.5e3;        // Alpha energy (keV)

var elon= 2.0;
var zEff = 1.65;       // Z-effective
var zImp = 6.0;        // Z of dominant impurity
var rnDnDT = 0.5;      // deuterium / (deuterium + tritium) ratio
var cTau = 1.80;       // Confinement enhancement multiplier
var tauPHe = 15.;      // Helium ash particle confinement time (seconds)
var rmin = 0.795;
var rmaj = 2.59;
var q = 2.3;
var Nhe = 0; //Helium ash
var cAsh = 0; //Helium ash coefficient

var area = Math.PI*rmin*rmin*elon;
var volume = 2*Math.PI*rmaj*area;

var b_c_ratio = q * 1.e6 * MU_0 * rmaj / (Math.PI * rmin*rmin * (1. + elon*elon));

//************Programatic variables***********

var finalOut = {};
var finalTemp = 0;
var finalScore = 0;
// var magVal = 14;
var magVal = 1;
var densVal = 2.5;
var powVal = 0.19;
var magMax = 20;
var densMax = 10;
var powMax = 10;


//==============================================================================
//                                  START
//==============================================================================

var Params = function() {
  this.scale = 1.5;
  this.tscale = 0.1;
  // this.T = 10000;
  this.B = 1;
  this.Dens = 2.5;
  this.Pow = 0.19;
};

var Torus = {R:60, r:100};
var Plasma = {v: 1, wSpread: 0.5/1000, T: 10000};
var params = new Params();
var gui = new dat.GUI();
gui.add(params, 'scale', 0.1, 3);
gui.add(params, 'tscale', 0.01, 0.5);
// gui.add(params, 'T', 1000, 1000);
gui.add(params, 'B', 1, 14);
gui.add(params, 'Dens', 0, 10);
gui.add(params, 'Pow', 0, 10);


// stats
var stats = new Stats();
stats.domElement.style.position = 'absolute';
stats.domElement.style.left = '0px';
stats.domElement.style.top = '0px';
document.body.appendChild( stats.domElement );

// PIXI

// ///////////////////////////////////////////////////////////
// Particle
// ///////////////////////////////////////////////////////////

var renderer = PIXI.autoDetectRenderer(width, height);
document.body.appendChild(renderer.view);

// create the root of the scene graph
var stage = new PIXI.Container();
// stage.position.x = renderer.width / 2;
// stage.position.y = renderer.height / 2;

// stage.interactive = true;

var container = new PIXI.Container();
container.position.x = renderer.width / 2;
container.position.y = renderer.height / 2;

stage.addChild(container);

// holder to store the aliens
var aliens = [];

var totalDudes = 1000;

for (var i = 0; i < totalDudes; i++)
{

    var angle = 2 * Math.PI * Math.random();

    // create a new Sprite that uses the image name that we just generated as its source
    // var dude =  PIXI.Sprite.fromImage('spark3.png');
    var dude =  PIXI.Sprite.fromImage('spark5.png');

    // set the anchor point so the texture is centerd on the sprite
    dude.anchor.set(0.5);

    // set a random scale for the dude - no point them all being the same size!
    dude.scale.set(1.4 + Math.random() * 0.3);

    // finally lets set the dude to be at a random position..
    dude.R = Torus.R + 100*Math.pow(Math.sin(angle*10), 2);
    dude.position.x = Math.cos(dude.phi) * dude.R * params.scale;
    dude.position.y = Math.sin(dude.phi) * dude.R * params.scale;
    dude.phi = 0;
    dude.phiBias = 0;
    dude.phiRun = 0;
    dude.phiStart = angle;
    dude.displ = {};
    dude.displ.x = (Math.random()-1) * 50;
    dude.displ.y = (Math.random()-1) * 50;
    // dude.w = Plasma.w * (Math.random() > 0.5 ? 1 : -1) + Plasma.wSpread * Math.random();
    // dude.w = Plasma.v / dude.R;
    dude.w = Plasma.v / Torus.R;

    // dude.tint = Math.random() * 0xFFFFFF;
    // dude.tint = (0.7+Math.random() * 0.001) * 0xFFFFFF;
    // dude.PIXI.filters.BloomFilter(10);

    // create some extra properties that will control movement :
    // create a random direction in radians. This is a number between 0 and PI*2 which is the equivalent of 0 - 360 degrees
    // dude.direction = Math.random() * Math.PI * 2;

    // this number will be used to modify the direction of the dude over time
    // dude.turningSpeed = Math.random() - 0.8;

    // create a random speed for the dude between 0 - 2
    // dude.speed = (2 + Math.random() * 2)/10;


    // finally we push the dude into the aliens array so it it can be easily accessed later
    aliens.push(dude);

    container.addChild(dude);
}

function displayScore(){
  finalTemp = bisection();
  finalOut = calcScore(finalTemp);
}

var bg = PIXI.Sprite.fromImage("img/reactor.png");
bg.position = ({x:width/2, y:height/2});
// bg.position.x = (width/2);
// bg.offset.x = (width/2);
bg.anchor.set(0.5);
bg.scale.set(1,1);
// stage.addChild(bg);


// var colorMatrix =  [
//     1,0,0,0.5,
//     0,1,0,0.5,
//     0,0,1,0.5,
//     0,0,0,1
// ];
// var filter = new PIXI.filters.ColorMatrixFilter();
// filter.matrix = colorMatrix;
// stage.filters = [filter];

// var blurFilter1 = new PIXI.filters.BlurFilter();
// var blurFilter1 = new  PIXI.filters.InvertFilter()
var blurFilter1 = new PIXI.filters.BloomFilter();
// var blurFilter1 = new PIXI.filters.GrayFilter();
// var blurFilter1 = new PIXI.filters.PixelateFilter();
// var blurFilter1 = new PIXI.filters.TwistFilter();
// var blurFilter1 = new PIXI.filters.NoiseFilter();
// var blurFilter1 = new PIXI.filters.DropShadowFilter();
// var blurFilter1 = new PIXI.filters.SepiaFilter();
// var blurFilter1 = new PIXI.filters.SmartBlurFilter();
// var blurFilter1 = new PIXI.filters.CrossHatchFilter();  // *
// var blurFilter1 = new PIXI.filters.TiltShiftFilter();
// var blurFilter1 = new PIXI.filters.BlurDirFilter(0.5, 0.5);
stage.filters = [blurFilter1];
// var blurAmount1 = 0.01 ;

var count = 0;

// create a bounding box for the little dudes
var dudeBoundsPadding = 2;
var dudeBounds = new PIXI.Rectangle(-dudeBoundsPadding,
                                    -dudeBoundsPadding,
                                    renderer.width + dudeBoundsPadding * 2,
                                    renderer.height + dudeBoundsPadding * 2);

var tick = 0;

requestAnimationFrame(animate);

function animate() {

    magVal = params.B;
    densVal = params.Dens;
    powVal = params.Pow;
    displayScore();

    document.getElementById("status").value = ("Temp: " + finalTemp);
    document.getElementById("console").value = ('Mag: ' + magVal + '\n' + 'Dens: ' + densVal + '\n' + 'Pow: ' + powVal + '\n\n' + 'Temp: ' + finalTemp  + '\n' + 'Score: ' + finalScore + '\n\n' + 'P_oh: ' + finalOut.P_oh * 1.e-6 + '\n' + 'P_alpha: ' + finalOut.P_alpha * 1.e-6 + '\n' + 'P_cond: ' + finalOut.P_cond * 1.e-6 + '\n' + 'P_rad: ' + finalOut.P_rad * 1.e-6 + '\n\n' + 'Beta thermal: ' + finalOut.beta_th + '\n' + 'Beta alpha: ' + finalOut.beta_falpha + '\n'+ 'Beta: ' + finalOut.beta + '\n' + 'Beta max: ' + finalOut.betamax + '\n\n' + 'Density: ' + finalOut.densreal*1.e-20 + '\n' + 'Dens_max: ' + finalOut.densmax*1.e-20 + '\n');

    Plasma.v = 1 + 3 * Params.Pow/1000;
    // iterate through the dudes and update their position
    for (var i = 0; i < aliens.length; i++)
    {
        var dude = aliens[i];
        // dude.direction += dude.turningSpeed * 0.01;
        // dude.position.x += Math.sin(dude.direction) * dude.speed;
        // dude.position.y += Math.cos(dude.direction) * dude.speed;
        // dude.rotation = -dude.direction - Math.PI / 2;
        dude.rotation = dude.direction;
        // Plasma.v / Torus.R;

        // dude.w += (aliens[1].phi % (2*Math.PI)) % rotSep

        // if dude.phiBias > 0 {}
        // dude.R = Torus.R + 40*Math.sin(dude.phi*20)*(1);
        dude.R = Torus.R - 20 + 100*Math.pow(Math.sin((dude.phiRun+dude.phiStart)*10),2);
        dude.phiBias =  ( Math.pow(Math.sin((dude.phiRun+dude.phiStart)*10),2) * Math.PI) * (magVal-1)/magMax;
        // dude.phiBias = (dude.R - Torus.R)/40 * Math.PI/2 * magVal/magMax;
        dude.phiRun += dude.w * params.tscale;
        // dude.phi = dude.phiBias + dude.phiRun;
        dude.phi = dude.phiRun + dude.phiStart + dude.phiBias;
        // dude.displ = (magval-magMax)/magMax;
        // console.log(dude.phi);
        // this.particleStore[i].R = Torus.R + 40*Math.sin(this.particleStore[i].phi*10);
        // dude.R += (Torus.R - dude.R) * (params.B-1) / 1000
                                // - (Torus.R - dude.R) / 100 * Math.random() * Math.sin(2 * Math.PI * Math.random());
        // this.particleStore[i].R *= (1 + 0.01*Math.sin(2*Math.PI*lastTime/1000)+0.01*Math.cos(this.particleStore[i].phi));

        // dude.scale.set(0.6+0.4*Math.pow(Math.sin(dude.phi*20),2));
        dude.scale.set(0.65+0.35*Math.sin((dude.phiRun+dude.phiStart)*20));
        // dude.scale.set(0.5+0.5*Math.pow(Math.sin((dude.phiRun+dude.phiStart)*20),2));
        dude.x = Math.cos(dude.phi) * dude.R * params.scale + (Math.random()-1) * powVal + dude.displ.x * (magVal-magMax)/magMax;
        dude.y = Math.sin(dude.phi) * dude.R * params.scale + (Math.random()-1) * powVal + dude.displ.y * (magVal-magMax)/magMax;
        // dude.tint = (0.7+Math.random() * 0.001) * 0xFFFFFF;
        dude.tint = (0.7+(finalTemp/1000) * 0.0001) * 0xFFFFFF;
        dude.alpha = 0.1 + densVal / 10 * 0.7;
        // dude.alpha = i > aliens.length * densVal/10 ? 0 : 1;
        // dude.alpha = (Math.random() + densVal/10) > 1 ? 1 : 0;

    }

    // console.log(aliens[1].phi % (2*Math.PI));
    // increment the ticker
    tick += 0.1;

    // time to render the stage!
    renderer.render(stage);

    // request another animation frame...
    requestAnimationFrame(animate);
}
//==============================================================================
//                                     END
//==============================================================================

</script>

</body>

</html>